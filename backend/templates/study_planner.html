<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adaptive Study Planner - MindMuse</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
body { background: #f8fafc; font-family: 'Poppins', sans-serif; }
.container { margin-top: 30px; margin-bottom: 50px; }
table { background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
th { background-color: #2563eb; color: white; }
td { vertical-align: middle; position: relative; padding: 8px; }
.break { background-color: #fef3c7; } 
.review { background-color: #d1fae5; } 
.completed { text-decoration: line-through; color: #16a34a; } 
.starred { background-color: #fde68a !important; font-weight: bold; } 
.btn-small { font-size: 10px; padding: 2px 6px; margin-left: 2px; border-radius: 12px; cursor: pointer; }
</style>
</head>
<body>
<div class="container">
  <h2 class="text-primary fw-bold mb-4">üìä Adaptive Study Planner</h2>

  <div class="card p-4 shadow-sm mb-4">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Subjects (comma-separated)</label>
        <input type="text" id="subjects" class="form-control" placeholder="Maths, Physics, Biology">
      </div>
      <div class="col-md-4">
        <label class="form-label">Knowledge Levels (comma-separated)</label>
        <input type="text" id="knowledge" class="form-control" placeholder="beginner, intermediate, advanced">
      </div>
      <div class="col-md-2">
        <label class="form-label">Available Study Hours</label>
        <input type="number" id="hours" class="form-control" value="3">
      </div>
      <div class="col-md-2">
        <label class="form-label">Preferred Study Hours</label>
        <input type="text" id="pref_hours" class="form-control" value="18:00-21:00">
      </div>
      <div class="col-md-4">
        <label class="form-label">Break Preference</label>
        <input type="text" id="breaks" class="form-control" value="10 mins after every hour">
      </div>
      <div class="col-md-2">
        <label class="form-label">Mode</label>
        <select id="mode" class="form-select">
          <option>Weekly</option>
          <option>Deadline</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Deadline (for deadline mode)</label>
        <input type="date" id="deadline" class="form-control">
      </div>
    </div>
    <div class="text-end mt-3">
      <button class="btn btn-primary" onclick="generatePlan()">‚ú® Generate Plan</button>
      <button class="btn btn-success" onclick="savePlan()">üíæ Save to Dashboard</button>
      <button class="btn btn-secondary" onclick="downloadImage()">‚¨áÔ∏è Download Image</button>
    </div>
  </div>

  <div id="planContainer"></div>
</div>

<script>
// --- Utility for buttons ---
function addCellButtons(td, plan=null, dayIdx=null, taskIdx=null) {
  const starBtn = document.createElement('button');
  starBtn.innerHTML = '‚≠ê';
  starBtn.className = 'btn-small';
  starBtn.onclick = () => {
    td.classList.toggle('starred');
    if(plan && dayIdx!==null && taskIdx!==null){
      plan[dayIdx].tasks[taskIdx].starred = !plan[dayIdx].tasks[taskIdx].starred;
      localStorage.setItem('dashboardPlan', JSON.stringify(plan));
    }
  };

  const completeBtn = document.createElement('button');
  completeBtn.innerHTML = '‚úîÔ∏è';
  completeBtn.className = 'btn-small';
  completeBtn.onclick = () => {
    td.classList.toggle('completed');
    if(plan && dayIdx!==null && taskIdx!==null){
      plan[dayIdx].tasks[taskIdx].completed = !plan[dayIdx].tasks[taskIdx].completed;
      localStorage.setItem('dashboardPlan', JSON.stringify(plan));
    }
  };

  td.appendChild(document.createElement('br'));
  td.appendChild(starBtn);
  td.appendChild(completeBtn);
}

// --- Display plan after generation ---
function displayPlan(plan, mode){
  if(!plan || plan.length===0) return;
  const container = document.getElementById('planContainer');
  let html = '<table class="table table-bordered"><thead><tr><th>Time</th>';
  plan.forEach(d=>{
    html+=`<th>${mode.toLowerCase()==='weekly'?d.day:d.date}</th>`;
  });
  html+='</tr></thead><tbody>';

  const times = [...new Set(plan.flatMap(d=>d.tasks.map(t=>t.time)))].sort();
  times.forEach(time=>{
    html+=`<tr><td>${time}</td>`;
    plan.forEach(d=>{
      const task = d.tasks.find(t=>t.time===time);
      const subj = task?task.subject:'-';
      const cls = subj.toLowerCase().includes('break')?'break':subj.toLowerCase().includes('review')?'review':'';
      html+=`<td class="${cls}">${subj}</td>`;
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  container.innerHTML=html;

  // Add buttons
  plan.forEach((d, dayIdx)=>{
    d.tasks.forEach((t, taskIdx)=>{
      const rows = container.querySelectorAll('tr');
      rows.forEach(row=>{
        const td = Array.from(row.cells).find(c=>c.innerText===t.subject);
        if(td) addCellButtons(td, plan, dayIdx, taskIdx);
      });
    });
  });
}

// --- Save to Dashboard ---
function savePlan(){
  const latestPlan = JSON.parse(localStorage.getItem('latestPlan') || '[]');
  if(latestPlan.length===0){ alert('‚ö†Ô∏è Generate plan first!'); return; }
  localStorage.setItem('dashboardPlan', JSON.stringify(latestPlan));
  alert('‚úÖ Plan saved to dashboard!');
}

// --- Download table ---
function downloadImage(){
  const container=document.getElementById('planContainer');
  if(!container.innerHTML.trim()){ alert('‚ö†Ô∏è No plan to download!'); return; }
  html2canvas(container).then(canvas=>{
    const link=document.createElement('a');
    link.download='study_plan.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  });
}

// --- Generate plan ---
async function generatePlan(){
  const data={
    subjects: document.getElementById('subjects').value.split(',').map(s=>s.trim()),
    knowledge: document.getElementById('knowledge').value.split(',').map(k=>k.trim()),
    available_hours: document.getElementById('hours').value,
    preferred_hours: document.getElementById('pref_hours').value,
    breaks: document.getElementById('breaks').value,
    mode: document.getElementById('mode').value,
    deadline: document.getElementById('deadline').value
  };

  const res=await fetch('/generate_plan',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
  const result=await res.json();

  // Add day names for weekly mode
  if(data.mode.toLowerCase()==='weekly'){
    const dayNames=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    result.plan.forEach((d,i)=>{ d.day=dayNames[i%7]; });
  }

  localStorage.setItem('latestPlan', JSON.stringify(result.plan));
  displayPlan(result.plan, data.mode);
}
</script>
</body>
</html>
