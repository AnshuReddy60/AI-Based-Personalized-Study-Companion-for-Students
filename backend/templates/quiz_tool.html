<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .quiz-wrapper { max-width: 800px; margin: auto; }
    .card { margin-bottom: 20px; }
    .option-label {
      display: block;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .option-label:hover { background-color: #f1f1f1; }
    input[type="radio"] { display: none; }
    input[type="radio"]:checked + .option-label {
      background-color: #cfe2ff;
      border-color: #9ec5fe;
    }
    .correct { background-color: #d4edda !important; border-color: #badbcc !important; }
    .wrong { background-color: #f8d7da !important; border-color: #f5c2c7 !important; }
  </style>
</head>
<body>
<div class="container quiz-wrapper mt-5">
  <h2 class="mb-4 text-center">Quiz Tool</h2>

  <div class="card p-4 mb-4 shadow-sm">
    <div class="mb-3">
        <label class="form-label">Enter Topic:</label>
        <input type="text" id="topic" class="form-control" placeholder="e.g., Photosynthesis">
    </div>
    <div class="mb-3">
        <label class="form-label">Mode:</label>
        <select id="mode" class="form-select">
            <option value="normal">Normal</option>
            <option value="test">Test</option>
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Difficulty:</label>
        <select id="difficulty" class="form-select">
            <option value="easy">Easy</option>
            <option value="hard">Hard</option>
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Number of Questions:</label>
        <input type="number" id="num_questions" class="form-control" value="10" min="5" max="15">
    </div>
    <button id="generateBtn" class="btn btn-primary" onclick="generateQuiz()">Generate Quiz</button>
    <span id="loadingText" style="margin-left:10px; display:none;">⏳ Please wait, generating...</span>
</div>

<div id="quizContainer"></div>

<div class="text-center mt-3">
    <button id="submitBtn" class="btn btn-success" style="display:none;" onclick="submitQuiz()">Submit Answers</button>
    <button id="retryBtn" class="btn btn-secondary" style="display:none;" onclick="generateQuiz()">Retry Quiz</button>
</div>
<div id="scoreDiv" class="mt-3 text-center"></div>
</div>

<script>
let currentQuiz = [];
let mode = "normal";

function generateQuiz() {
    const topic = document.getElementById("topic").value;
    mode = document.getElementById("mode").value;
    const difficulty = document.getElementById("difficulty").value;
    const num_questions = document.getElementById("num_questions").value;

    if (!topic) { alert("Please enter a topic"); return; }

    document.getElementById("loadingText").style.display = "inline"; 

    fetch("/generate_quiz", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `topic=${encodeURIComponent(topic)}&mode=${mode}&difficulty=${difficulty}&num_questions=${num_questions}`
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("loadingText").style.display = "none";
        if (data.error) {
            alert(data.error);
            return;
        }
        currentQuiz = data.quiz;
        displayQuiz(currentQuiz);
    })
    .catch(err => {
        document.getElementById("loadingText").style.display = "none";
        alert("❌ Error generating quiz!");
        console.error(err);
    });
}

function displayQuiz(quiz) {
    const container = document.getElementById("quizContainer");
    container.innerHTML = "";
    document.getElementById("scoreDiv").innerHTML = "";

    quiz.forEach((q, idx) => {
        const card = document.createElement("div");
        card.className = "card p-3 shadow-sm";

        const question = document.createElement("p");
        question.innerHTML = `<strong>Q${idx+1}:</strong> ${q.question}`;
        card.appendChild(question);

        q.options.forEach((opt, optIdx) => {
            const optId = `q${idx}_opt${optIdx}`;

            const input = document.createElement("input");
            input.type = "radio";
            input.name = `question${idx}`;
            input.id = optId;
            input.value = opt;

            input.onchange = () => {
                if (mode === "test") {
                    q.user_answer = opt;
                }
            };

            const label = document.createElement("label");
            label.className = "option-label";
            label.setAttribute("for", optId);
            label.innerText = opt;

            card.appendChild(input);
            card.appendChild(label);
        });

        container.appendChild(card);
    });

    if (mode === "test") {
        document.getElementById("submitBtn").style.display = "inline-block";
        document.getElementById("retryBtn").style.display = "inline-block";
    } else {
        document.getElementById("submitBtn").style.display = "none";
        document.getElementById("retryBtn").style.display = "none";
    }
}
function submitQuiz() {
    if (!currentQuiz || currentQuiz.length === 0) return;

    // Calculate score
    let score = 0;
    currentQuiz.forEach(q => {
        if (q.user_answer === q.answer) score++;
    });
    const total = currentQuiz.length;

    // Display score
    document.getElementById("scoreDiv").innerHTML = `<h4>Your Score: ${score} / ${total}</h4>`;

    // Show correct/wrong answers
    const cards = document.querySelectorAll("#quizContainer .card");
    currentQuiz.forEach((q, idx) => {
        const labels = cards[idx].querySelectorAll(".option-label");
        labels.forEach(label => {
            if (label.innerText === q.answer) label.classList.add("correct");
            else if (label.innerText === q.user_answer) label.classList.add("wrong");
        });
    });

    // Send attempt to backend
    fetch("/record_quiz_attempt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ score: score, total_questions: total })
    })
    .then(async res => {
        if (!res.ok) {
            const text = await res.text();
            console.error("Backend error response:", text);
            return;
        }
        return res.json();
    })
    .then(data => {
        if (data?.error) console.error("Error recording attempt:", data.error);
        else console.log("[INFO] Quiz attempt recorded successfully:", data.message);

        // Refresh dashboard automatically if open
        if (typeof loadDashboardData === "function") loadDashboardData();
    })
    .catch(err => {
        console.error("Error sending attempt:", err);
    });
}
</script>
</body>
</html>
